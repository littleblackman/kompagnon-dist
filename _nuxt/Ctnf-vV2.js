import{a2 as g,u,z as p}from"./kYLNFxuI.js";const m=g("personnage",{state:()=>({personnages:[],detectionConfig:{maxDistance:3,minLength:3,minConfidence:.6},detectedCharacters:[],showDetectionModal:!1,currentSequenceId:null}),getters:{getPersonnagesByProject:t=>e=>t.personnages.filter(s=>s.project_id===e),getPersonnageName:()=>t=>t?[t.firstName,t.lastName].filter(Boolean).join(" "):""},actions:{setDetectionConfig(t){this.detectionConfig={...this.detectionConfig,...t}},levenshteinDistance(t,e){const s=[];for(let n=0;n<=e.length;n++)s[n]=[n];for(let n=0;n<=t.length;n++)s[0][n]=n;for(let n=1;n<=e.length;n++)for(let r=1;r<=t.length;r++)e.charAt(n-1)===t.charAt(r-1)?s[n][r]=s[n-1][r-1]:s[n][r]=Math.min(s[n-1][r-1]+1,s[n][r-1]+1,s[n-1][r]+1);return s[e.length][t.length]},analyzeContent(t){var i,c;if(console.log("analyzeContent called with content length:",t.length),console.log("Available personnages from store:",this.personnages.map(o=>({id:o.id,firstName:o.firstName,lastName:o.lastName}))),!t||this.personnages.length===0)return console.log("No content or no personnages available"),[];const e=t.toLowerCase().replace(/<[^>]*>/g," ").replace(/[^\w\s]/g," ").replace(/\s+/g," ").trim();console.log("Clean content:",e.substring(0,200));const s=[...new Set(e.split(" ").filter(o=>o.length>=this.detectionConfig.minLength))];console.log("Words to analyze:",s);const n=[];for(const o of s)for(const a of this.personnages){const h=((i=a.firstName)==null?void 0:i.toLowerCase())||"",d=((c=a.lastName)==null?void 0:c.toLowerCase())||"";if(console.log(`Comparing word "${o}" with ${h}/${d}`),h&&this.isMatch(o,h)){const l=this.levenshteinDistance(o,h),f=1-l/Math.max(o.length,h.length);console.log(`Match found: ${o} -> ${h} (distance: ${l}, confidence: ${f})`),n.push({name:o,personnage:a,isExisting:!0,confidence:f})}if(d&&this.isMatch(o,d)){const l=this.levenshteinDistance(o,d),f=1-l/Math.max(o.length,d.length);console.log(`Match found: ${o} -> ${d} (distance: ${l}, confidence: ${f})`),n.push({name:o,personnage:a,isExisting:!0,confidence:f})}}console.log("All detected before filtering:",n);const r=n.filter(o=>o.confidence>=this.detectionConfig.minConfidence).filter((o,a,h)=>a===h.findIndex(d=>{var l,f;return((l=d.personnage)==null?void 0:l.id)===((f=o.personnage)==null?void 0:f.id)&&d.name===o.name})).sort((o,a)=>a.confidence-o.confidence);return console.log("Final unique detected:",r),r},isMatch(t,e){return this.levenshteinDistance(t,e)<=this.detectionConfig.maxDistance},async detectAndSuggestCharacters(t,e){console.log("detectAndSuggestCharacters called with:",{content:t.substring(0,100),sequenceId:e,personnagesCount:this.personnages.length});const s=this.analyzeContent(t);console.log("Detected characters:",s),s.length>0?(this.detectedCharacters=s,this.currentSequenceId=e,this.showDetectionModal=!0,console.log("Modal should be shown now")):console.log("No characters detected")},closeDetectionModal(){this.showDetectionModal=!1,this.detectedCharacters=[],this.currentSequenceId=null},async addPersonnageToSequence(t,e){try{const s=p(),n=u();return await $fetch(`${s.public.apiBase}/sequence/personnage/add`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n.token}`},body:{sequenceId:e,personnageId:t}}),!0}catch(s){return console.error("Erreur lors de l'ajout du personnage à la séquence :",s),!1}},async savePersonnage(t,e){try{const s=p(),n=u(),r={...t,project_id:e},i=await $fetch(`${s.public.apiBase}/personnage/update`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n.token}`},body:r}),c=this.personnages.findIndex(o=>o.id===i.id);return c!==-1?this.personnages[c]=i:this.personnages.push(i),i}catch(s){return console.error("Erreur lors de la sauvegarde d'un personnage :",s),null}},async deletePersonnage(t){try{const e=p(),s=u();return await $fetch(`${e.public.apiBase}/personnage/delete/${t}`,{method:"DELETE",headers:{Authorization:`Bearer ${s.token}`}}),this.personnages=this.personnages.filter(n=>n.id!==t),!0}catch(e){return console.error("Erreur lors de la suppression du personnage :",e),!1}},async removePersonnageFromSequence(t,e){try{const s=p(),n=u();return await $fetch(`${s.public.apiBase}/sequence/personnage/remove/${t}/${e}`,{method:"DELETE",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n.token}`}}),!0}catch(s){return console.error("Erreur lors de la suppression de l'assignation personnage-séquence :",s),!1}},async uploadImages(t,e){try{const s=p(),n=u(),r=new FormData;e.forEach(o=>{r.append("images[]",o)});const i=await $fetch(`${s.public.apiBase}/personnage/${t}/upload-images`,{method:"POST",headers:{Authorization:`Bearer ${n.token}`},body:r}),c=this.personnages.find(o=>o.id===t);if(c){let o=c.images||[];if(typeof o=="string")try{o=JSON.parse(o)}catch{o=[]}Array.isArray(o)||(o=[]),c.images=[...o,...i.images],!c.avatar&&i.images.length>0&&(c.avatar=i.images[0])}return i.images}catch(s){throw console.error("Erreur lors de l'upload des images :",s),s}},async reorderImages(t,e){try{const s=p(),n=u();await $fetch(`${s.public.apiBase}/personnage/${t}/reorder-images`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n.token}`},body:{images:e}});const r=this.personnages.find(i=>i.id===t);return r&&(r.images=e,e.length>0&&(r.avatar=e[0])),!0}catch(s){throw console.error("Erreur lors de la réorganisation des images :",s),s}},async deleteImage(t,e){try{const s=u(),n=p();await $fetch(`${n.public.apiBase}/personnage/${t}/delete-image`,{method:"DELETE",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s.token}`},body:{imageUrl:e}});const r=this.personnages.find(i=>i.id===t);if(r&&r.images){let i=r.images;if(typeof i=="string")try{i=JSON.parse(i)}catch{i=[]}Array.isArray(i)||(i=[]),r.images=i.filter(c=>c!==e),r.avatar===e&&(r.avatar=r.images.length>0?r.images[0]:void 0)}return!0}catch(s){throw console.error("Erreur lors de la suppression de l'image :",s),s}},setPersonnages(t){console.log("Initializing personnages reference table with:",t.length,"characters"),this.personnages=t||[]}}}),$=g("project",{state:()=>({project:null,parts:[],sequences:[],scenes:[],personnages:[],expandedParts:new Set,sortOrder:"position",filters:{search:"",status:"all"},stats:{wordCount:0,charCount:0}}),getters:{isPartExpanded:t=>e=>t.expandedParts.has(e)},actions:{async fetchProject(t){try{const e=p(),s=u(),n=await $fetch(`${e.public.apiBase}/project/${t}`,{headers:{Authorization:`Bearer ${s.token}`}}),r=(n.parts||[]).sort((c,o)=>c.position-o.position).map(c=>({...c,sequences:(c.sequences||[]).sort((o,a)=>o.position-a.position).map(o=>({...o,scenes:(o.scenes||[]).sort((a,h)=>a.position-h.position)}))}));this.project={...n,parts:r},this.parts=r,this.sequences=this.parts.flatMap(c=>c.sequences||[]),this.scenes=this.sequences.flatMap(c=>c.scenes||[]),this.personnages=n.personnages||[];const i=m();i.personnages=n.personnages||[],this.expandAllParts(),this.calculateStats(),typeof window<"u"&&n&&localStorage.setItem("lastVisitedProject",JSON.stringify({id:n.id,name:n.name,slug:n.slug,timestamp:new Date().toISOString()}))}catch(e){console.error("Erreur chargement projet :",e)}},addPartToState(t){this.project&&(this.project.parts.push(t),this.parts.push(t),this.expandedParts.add(t.id))},updatePart(t){if(!this.project)return;const e=this.project.parts.findIndex(s=>s.id===t.id);if(e!==-1){this.project.parts[e]=t;const s=this.parts.findIndex(n=>n.id===t.id);s!==-1&&(this.parts[s]=t)}},addSequence(t){if(!this.project)return;const e=this.project.parts.find(s=>s.id===t.part_id);e&&(e.sequences||(e.sequences=[]),e.sequences.push(t))},addScene(t){if(this.project){for(const e of this.project.parts)if(e.sequences){for(const s of e.sequences)if(s.id===t.sequence_id){s.scenes||(s.scenes=[]),s.scenes.push(t);return}}}},togglePart(t){this.expandedParts.has(t)?this.expandedParts.delete(t):this.expandedParts.add(t)},collapseAllParts(){this.expandedParts.clear()},expandAllParts(){this.project&&this.project.parts.forEach(t=>{this.expandedParts.add(t.id)})},toggleSort(){const t=["position","name","date"],e=t.indexOf(this.sortOrder);this.sortOrder=t[(e+1)%t.length],this.sortParts()},sortParts(){this.project&&this.project.parts.sort((t,e)=>{switch(this.sortOrder){case"name":return t.name.localeCompare(e.name);case"date":return e.id-t.id;default:return t.position-e.position}})},toggleFilter(){const t=["all","completed","in-progress"],e=t.indexOf(this.filters.status);this.filters.status=t[(e+1)%t.length]},setSearchFilter(t){this.filters.search=t},async deletePart(t){try{const e=p(),s=u();await $fetch(`${e.public.apiBase}/part/delete/${t}`,{method:"DELETE",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s.token}`}});const n=this.parts.findIndex(r=>r.id===t);this.parts.splice(n,1)}catch(e){console.error("Erreur lors de la suppression d'une partie :",e)}},async saveCriteria(t,e,s){try{const n=p(),r=u(),i={sequenceId:e,criteriaId:s,value:t},c=await $fetch(`${n.public.apiBase}/criteria/update`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r.token}`},body:i})}catch(n){console.error("Erreur lors de l'ajout/mise à jour d'une partie :",n)}},async addPart(t,e){if(!this.project){console.error("Aucun projet chargé.");return}try{const s=p(),n=u();e&&(t.afterPartId=e);const r=await $fetch(`${s.public.apiBase}/part/update`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n.token}`},body:t}),{part:i,positions:c}=r,o=this.parts.findIndex(a=>a.id===i.id);if(o!==-1)this.parts[o]={...this.parts[o],name:i.name,description:i.description};else if(e){const a=this.parts.findIndex(h=>h.id===e);this.parts.splice(a+1,0,i)}else this.parts.unshift(i);c&&c.length>0&&this.parts.sort((a,h)=>c.indexOf(a.id)-c.indexOf(h.id)),this.project.parts=[...this.parts]}catch(s){console.error("Erreur lors de l'ajout/mise à jour d'une partie :",s)}},async updateSequenceContent(t){var e;try{const s=p(),n=u(),i=(await $fetch(`${s.public.apiBase}/sequence/update`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n.token}`},body:t})).sequence,c=(e=this.project)==null?void 0:e.parts.find(o=>o.id===t.part_id);if(c&&c.sequences){const o=c.sequences.findIndex(a=>a.id===i.id);if(o!==-1){const a=c.sequences[o];a.name=i.name,a.description=i.description,a.intention=i.intention,a.aesthetic_idea=i.aesthetic_idea,a.information=i.information,a.status=i.status}}return i}catch(s){return console.error("Erreur lors de la mise à jour de la séquence :",s),null}},async reorderSequence(t,e,s){try{const n=p(),r=u(),i={id:t,part_id:e};return s&&(i.afterSequenceId=s),await $fetch(`${n.public.apiBase}/sequence/update`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r.token}`},body:i}),await this.reloadPart(e),!0}catch(n){return console.error("Erreur lors de la réorganisation de la séquence :",n),!1}},async reloadPart(t){try{const e=p(),s=u(),n=await $fetch(`${e.public.apiBase}/part/${t}`,{headers:{Authorization:`Bearer ${s.token}`}});if(this.project&&this.project.parts){const r=this.project.parts.findIndex(i=>i.id===t);r!==-1&&(this.project.parts[r]=n.part)}this.sequences=this.parts.flatMap(r=>r.sequences||[]),this.scenes=this.sequences.flatMap(r=>r.scenes||[])}catch(e){console.error("Erreur lors du rechargement de la partie :",e)}},async saveSequence(t,e,s){var n;try{const r=p(),i=u();t.part_id=e,s&&(t.afterSequenceId=s);const o=(await $fetch(`${r.public.apiBase}/sequence/update`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i.token}`},body:t})).sequence,a=(n=this.project)==null?void 0:n.parts.find(h=>h.id===e);if(a&&(a.sequences||(a.sequences=[]),a.sequences=a.sequences.filter(h=>h.id!==o.id),a.sequences.push(o),a.sequences.sort((h,d)=>h.position-d.position)),this.sequences=this.sequences.filter(h=>h.id!==o.id),this.sequences.push(o),this.sequences.sort((h,d)=>h.position-d.position),this.project){const h=this.project.parts.find(d=>d.id===e);h&&(h.sequences=(a==null?void 0:a.sequences)||[])}return o}catch(r){return console.error("Erreur lors de la sauvegarde d'une séquence :",r),null}},async deleteSequence(t){try{const e=p(),s=u();if(await $fetch(`${e.public.apiBase}/sequence/delete/${t}`,{method:"DELETE",headers:{Authorization:`Bearer ${s.token}`}}),this.project){for(const r of this.project.parts)if(r.sequences){const i=r.sequences.findIndex(c=>c.id===t);if(i!==-1){r.sequences.splice(i,1);break}}}const n=this.sequences.findIndex(r=>r.id===t);n!==-1&&this.sequences.splice(n,1)}catch(e){throw console.error("Erreur lors de la suppression de la séquence :",e),e}},async saveScene(t,e,s){try{const n=p(),r=u();t.sequence_id=e,s&&(t.afterSceneId=s);const c=(await $fetch(`${n.public.apiBase}/scene/update`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r.token}`},body:t})).scene,o=this.sequences.find(a=>a.id===e);if(o&&(o.scenes||(o.scenes=[]),o.scenes=o.scenes.filter(a=>a.id!==c.id),o.scenes.push(c),o.scenes.sort((a,h)=>a.position-h.position)),this.project){for(const a of this.project.parts)if(a.sequences){for(const h of a.sequences)if(h.id===e){h.scenes||(h.scenes=[]),h.scenes=h.scenes.filter(d=>d.id!==c.id),h.scenes.push(c),h.scenes.sort((d,l)=>d.position-l.position);break}}}return this.scenes=this.scenes.filter(a=>a.id!==c.id),this.scenes.push(c),this.scenes.sort((a,h)=>a.position-h.position),this.calculateStats(),c}catch(n){return console.error("Erreur lors de la sauvegarde d'une scène :",n),null}},async saveSceneOrder(t){try{const e=p(),s=u(),n=t.map(r=>({id:r.id,position:r.position}));await $fetch(`${e.public.apiBase}/scene/order`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s.token}`},body:{scenes:n}})}catch(e){throw console.error("Erreur lors de la sauvegarde de l'ordre des scènes :",e),e}},async saveSequenceOrder(t){try{const e=p(),s=u(),n=t.map(r=>({id:r.id,position:r.position}));await $fetch(`${e.public.apiBase}/sequence/order`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s.token}`},body:{sequences:n}})}catch(e){throw console.error("Erreur lors de la sauvegarde de l'ordre des séquences :",e),e}},async updateSequenceMetadata(t,e){try{const s=p(),n=u(),r=await $fetch(`${s.public.apiBase}/sequence/${t}/metadata`,{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n.token}`},body:e});if(this.project&&this.project.parts){for(const i of this.project.parts)if(i.sequences){const c=i.sequences.findIndex(o=>o.id===t);if(c!==-1){e.intention!==void 0&&(i.sequences[c].intention=e.intention),e.aesthetic_idea!==void 0&&(i.sequences[c].aesthetic_idea=e.aesthetic_idea),e.information!==void 0&&(i.sequences[c].information=e.information);break}}}}catch(s){throw console.error("Erreur lors de la mise à jour des métadonnées de la séquence :",s),s}},async deleteScene(t){try{const e=p(),s=u();if(await $fetch(`${e.public.apiBase}/scene/delete/${t}`,{method:"DELETE",headers:{Authorization:`Bearer ${s.token}`}}),this.project){for(const r of this.project.parts)if(r.sequences){for(const i of r.sequences)if(i.scenes){const c=i.scenes.findIndex(o=>o.id===t);if(c!==-1){i.scenes.splice(c,1);break}}}}const n=this.scenes.findIndex(r=>r.id===t);n!==-1&&this.scenes.splice(n,1)}catch(e){throw console.error("Erreur lors de la suppression de la scène :",e),e}},async createProject(t){try{const e=p(),s=u();return await $fetch(`${e.public.apiBase}/project/update`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s.token}`},body:t})}catch(e){throw console.error("Erreur lors de la création du projet :",e),e}},async updateProject(t){try{const e=p(),s=u(),n=await $fetch(`${e.public.apiBase}/project/update`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s.token}`},body:t});return this.project&&this.project.id===t.id&&(this.project.name=t.name,this.project.description=t.description),n}catch(e){throw console.error("Erreur lors de la mise à jour du projet :",e),e}},async deleteProject(t){try{const e=p(),s=u();return await $fetch(`${e.public.apiBase}/project/delete/${t}`,{method:"DELETE",headers:{Authorization:`Bearer ${s.token}`}}),this.project&&this.project.id===t&&(this.project=null,this.parts=[],this.sequences=[],this.scenes=[],this.personnages=[],this.expandedParts.clear()),!0}catch(e){throw console.error("Erreur lors de la suppression du projet :",e),e}},calculateStats(){var i,c,o;if(!this.project){this.stats={wordCount:0,charCount:0};return}const e=(()=>{if(typeof window>"u")return{showTitles:{h2:!0,h3:!0,h4:!0}};const a=localStorage.getItem("kompagnon-reading-preferences");if(!a)return{showTitles:{h2:!0,h3:!0,h4:!0}};try{return JSON.parse(a)}catch{return{showTitles:{h2:!0,h3:!0,h4:!0}}}})();let s="";for(const a of this.project.parts||[]){(i=e.showTitles)!=null&&i.h2&&a.name&&(s+=a.name+" ");for(const h of a.sequences||[]){(c=e.showTitles)!=null&&c.h3&&h.name&&(s+=h.name+" ");for(const d of h.scenes||[])if((o=e.showTitles)!=null&&o.h4&&d.name&&(s+=d.name+" "),d.content){const l=d.content.replace(/<[^>]*>/g,"");s+=l+" "}}}const n=s.trim()?s.trim().split(/\s+/).length:0,r=s.length;this.stats={wordCount:n,charCount:r}}}});export{$ as a,m as u};
